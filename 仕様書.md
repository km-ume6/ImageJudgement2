概要
•	目的: 画像から円／矩形領域を検出し、検出領域をAI判定APIへ送信して OK/NG 判定する Windows デスクトップアプリケーション。
•	技術スタック: C# (.NET 10)、WinForms、OpenCvSharp、System.Drawing、Windows OCR (Windows.Media.Ocr)、HttpClient（AI API 通信）、（オプションで）Microsoft.Data.SqlClient。
主な機能（ユーザー向け）
•	画像ブラウズ（ツリービューでフォルダを管理、画像一覧から選択）
•	画像表示（プレビュー、拡大縮小対応）
•	自動検出: 画像から円を検出して切り抜き、AI判定を実行（AutoDetectCircleAndAiAsync）
•	手動検出: 円／矩形の検出と切り抜き（DetectAndSaveCircleImage、DetectAndSaveRectangleImage、DetectAndSaveCompositeImage）
•	OCRテスト/テキスト抽出（Windows OCR を利用、ROI 切り出し、前処理あり）
•	AI判定: 外部APIに画像を送信して判定結果を取得（AiModelClient.PredictImageAsync）
•	判定比較・正解率計測: フォルダ内の連続自動判定やモード比較（AutoBatchProcess 系）
•	設定保存/読み込み: AppSettings.json（ユーザープロファイル下）に永続化
•	ロギング・進捗表示: バッチ用進捗ダイアログ（AutoBatchProcessDialog）、フォルダ復元進捗（FolderRestoreProgressDialog）
主要コンポーネント（クラスと責務）
•	Form1（メインフォーム）
•	UI レイアウト、画像ロード、イベントハンドラ、設定読み書き（LoadAppSettings/SaveAppSettings）
•	自動検出/バッチ処理の起点
•	共有 AI クライアント管理（_sharedAiClient、GetOrCreateSharedAiClient）
•	検出関連（partial）
•	Form1.CircleDetection：円検出（HoughCircles）、切り抜き（CropCircleFromImage）
•	Form1.RectangleDetection：矩形検出（輪郭→多角形近似）、切り抜き（CropRectangleFromImage）
•	Form1.AutoDetection：円＋矩形を検出して合成画像生成（CreateCroppedCompositeImage、CombineImagesHorizontally）
•	OCR
•	Form1.OcrProcessing：Windows OCR の初期化、画像拡大／前処理、領域OCR（ExtractTextFromImageAsync、ExtractTextFromRectangleAsync）
•	AI クライアント
•	AiModelClient：API への画像送信、トークン取得、結果ポーリング、リトライ、タイムアウト管理（PredictImageAsync、SendImageAsync、GetPredictionResultAsync）
•	返却モデル: AiModelResult, ClassificationResult
•	判定モード: JudgeMode（TopClass / ScoreAverage / ScoreRanking）
•	判定評価
•	JudgementEvaluator：正解ラベル抽出（ファイルパスから 合格/不合格 を検出）、正解率計算、ログフォーマット、統計（JudgementStatistics）
•	DB ヘルパー（未使用だが実装あり）
•	DatabaseHelper：SQL Server アクセスラッパー（接続、実行、トランザクション、接続文字列ビルダ）
•	設定 UI
•	SettingsDialog：各種設定（検出パラメータ、AI API 情報、レイアウト、DB、ツリービュー等）を編集・インポート/エクスポート
•	設定永続化: AppSettings.json（Form1.Settings の SettingsFilePath）
•	バッチ／進捗ダイアログ
•	AutoBatchProcessDialog：一時停止・停止・ログ・正解率表示（UpdateProgress、UpdateAccuracy、AddLog、SetCompleted、SetStopped）
•	FolderRestoreProgressDialog：ツリービューの復元処理中に進捗表示（UIスレッド安全な更新メソッドを提供）
データ／処理フロー（代表的シナリオ）
1.	ユーザーがフォルダ／画像を選択 → LoadSelectedImageAsync が画像を読み込み、UI にセット。
2.	自動検出が有効の場合（chkAutoDetect）、AutoDetectCircleAndAiAsync を呼び出し：
•	円検出（DetectCircles）→ 切り抜き（CropCircleFromImage）→ 一時ファイル保存
•	AiModelClient.PredictImageAsync で API へ送信（内部で画像リサイズ、PNG 変換）
•	結果受信 → AiModelResult.Judge(detectionMode) で OK/NG 判定 → 表示（右下パネル等）
3.	バッチ処理:
•	StartAutoBatchProcessAsync または StartAutoBatchComparisonAsync → ExecuteAutoBatchProcessAsync / ExecuteAutoBatchComparisonAsync
•	進捗ダイアログを表示、並列ではなく逐次処理（途中で停止・一時停止可）、JudgementEvaluator で統計を採取・表示
4.	OCR ワークフロー:
•	画像を拡大／前処理 → Windows OCR 実行 → 抽出テキストから位置を検出して ROI を抽出 → 判定補助
主な設定項目（SettingsDialog / AppSettings）
•	レイアウト比率（左/右、上下分割）
•	円検出パラメータ: MinRadius, MaxRadius, Param1, Param2
•	矩形検出パラメータ: MinArea, MaxArea, CannyThreshold1, CannyThreshold2
•	自動検出フラグ
•	ツリービュー関連: TopLevelFolders, TreeDummyNodeThreshold, TreeSortAscending
•	AI API: AiApiKey, AiModelId, AiModelType, AiApiUrl
•	DB 接続情報（保存可だが現在無効化されている）
•	ウィンドウ位置・サイズ、最後に選択したパス
非機能要件／実装上の注意点
•	プラットフォーム: Windows（Windows.Media.Ocr・Windows.Storage を使用）
•	.NET: ターゲットは .NET 10（既存コード）
•	依存: OpenCvSharp、System.Drawing、Microsoft.Data.SqlClient（DB）、Windows SDK（OCR）
•	画像送信: 最大 1200px にリサイズして PNG に変換（AiModelClient.ResizeAndConvertToBytes）
•	タイムアウト／リトライ: HttpClient.Timeout = 60s、送信は1回リトライ、結果取得は最大 MaxRetryCount（10回）でポーリング
•	キャンセル対応: CancellationToken を受け取り、アプリ終了時にキャンセル（_appLifetimeCts）
•	リソース管理: AiModelClient は IDisposable、HttpClient は共有して再利用（ソケット枯渇回避）
•	エラーハンドリング: 各処理で try/catch、ダイアログやログ出力で通知
•	セキュリティ: 設定ファイルに API キーや DB 情報を平文で保存（留意点）
既知の制約・改善提案
•	Windows 専用（クロスプラットフォーム化には OCR と UI の置換が必要）
•	設定にシークレット（APIキー・DBパスワード）が平文保存される — 暗号化/OS シークレットストアの利用を推奨
•	AiModelClient のポーリング戦略やバックオフは簡易（指数バックオフの採用を検討）
•	並列での大量画像処理時のスロット制御（同時接続数制限）・スレッド利用の最適化が未実装
•	単体テストが少ない。JudgementEvaluator、AiModelClient（モックHttpClient）などからユニットテストを作成推奨
•	OCR 前処理や OpenCv のパラメータは UI 経由で調整可能だが、プロファイル保存機能の拡張が望ましい
外部 API / インターフェース（要約）
•	ローカル公開メソッド（利用可能な API）:
•	AiModelClient.PredictImageAsync(string imagePath, CancellationToken) → AiModelResult
•	Form1.DetectAndSaveCircleImage(string, string) → 生成ファイルパス / null
•	Form1.DetectAndSaveRectangleImage(string, string) → 生成ファイルパス / null
•	Form1.DetectAndSaveCompositeImage(string, string) → 生成ファイルパス / null
•	Form1.AutoDetectCircleAndAiAsync()（UI トリガ）
•	設定ファイル:
•	パス: %LocalAppData%\<AppName>\AppSettings.json（Form1.Settings.SettingsFilePath）
運用・テスト手順（簡易）
•	必要パッケージを restore（OpenCvSharp 等）
•	実行環境: Windows 10 以降、.NET 10 ランタイム
•	動作確認項目:
•	画像選択→自動検出→AI送信→結果表示
•	バッチ処理（自動連続判定開始）でログ・正解率の増減
•	OCRテスト（OCRテスト ボタン）
•	設定の保存/読み込み、エクスポート/インポート